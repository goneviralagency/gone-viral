
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gone Viral Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans p-4 min-h-screen">

  <!-- Hamburger Menu -->
  <div class="fixed top-2 right-2 z-50">
    <button onclick="toggleMenu()" class="bg-purple-700 p-2 rounded-full shadow-lg hover:bg-purple-600">☰</button>
    <div id="nav-menu" class="hidden bg-gray-900 text-white mt-2 rounded shadow-lg p-3 w-48">
      <button onclick="showSection('dashboard')" class="block w-full text-left py-1 hover:text-purple-300">Dashboard</button>
      <button onclick="showSection('availability-module')" class="block w-full text-left py-1 hover:text-purple-300">Availability</button>
      <button onclick="showSection('calendar-view')" class="block w-full text-left py-1 hover:text-purple-300">Calendar</button>
      <button onclick="showSection('cancel-battle-module')" class="block w-full text-left py-1 hover:text-purple-300">Cancel Battle</button>
      <button onclick="showSection('admin-panel')" class="block w-full text-left py-1 hover:text-purple-300">Admin Panel</button>
      <button onclick="logout()" class="block w-full text-left py-1 mt-2 text-red-400 hover:text-red-200">Logout</button>
    </div>
  </div>

  <!-- Login -->
  <div id="login-module" class="max-w-md mx-auto">
    <h1 class="text-2xl font-bold mb-4 text-center">Login</h1>
    <input id="login-email" type="email" placeholder="Email" class="w-full mb-2 p-2 bg-gray-800 rounded"/>
    <input id="login-password" type="password" placeholder="Password" class="w-full mb-2 p-2 bg-gray-800 rounded"/>
    <button onclick="login()" class="w-full bg-purple-600 p-2 rounded hover:bg-purple-500">Login</button>
    <p class="mt-2 text-sm text-center">
      <a href="#" onclick="showSignup()">New user?</a> | 
      <a href="#" onclick="resetPassword()">Forgot Password?</a>
    </p>
  </div>

  <!-- Signup -->
  <div id="signup-module" class="max-w-md mx-auto hidden">
    <h1 class="text-2xl font-bold mb-4 text-center">Sign Up</h1>
    <input id="signup-name" placeholder="Full Name" class="w-full mb-2 p-2 bg-gray-800 rounded"/>
    <input id="signup-tiktok" placeholder="TikTok Username" class="w-full mb-2 p-2 bg-gray-800 rounded"/>
    <input id="signup-email" type="email" placeholder="Email" class="w-full mb-2 p-2 bg-gray-800 rounded"/>
    <input id="signup-password" type="password" placeholder="Password" class="w-full mb-2 p-2 bg-gray-800 rounded"/>
    <select id="signup-timezone" class="w-full mb-2 p-2 bg-gray-800 rounded">
      <option value="">Select Timezone</option>
      <option value="US Eastern">US Eastern</option>
      <option value="Europe/Madrid">Europe/Madrid</option>
    </select>
    <select id="signup-diamonds" class="w-full mb-2 p-2 bg-gray-800 rounded">
      <option value="0-5K">0-5K</option>
      <option value="0-10K">0-10K</option>
      <option value="0-20K">0-20K</option>
      <option value="20-50K">20-50K</option>
      <option value="50-100K">50-100K</option>
      <option value="100-200K">100-200K</option>
      <option value="200K+">200K+</option>
    </select>
    <input id="signup-agency" placeholder="Agency (optional)" class="w-full mb-2 p-2 bg-gray-800 rounded"/>
    <button onclick="signup()" class="w-full bg-green-600 p-2 rounded hover:bg-green-500">Create Account</button>
    <p class="mt-2 text-sm text-center">
      <a href="#" onclick="showLogin()">Back to Login</a>
    </p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <h1 class="text-2xl font-bold mb-4">Welcome to Gone Viral</h1>
    <p id="user-info" class="mb-4 text-sm"></p>
  </div>

  <!-- Availability -->
  <div id="availability-module" class="hidden mt-6">
    <h2 class="text-xl font-bold mb-2">Set Your Weekly Availability</h2>
    <form id="availability-form" class="space-y-2">
      <div class="grid grid-cols-3 gap-2">
        <label class="col-span-1 text-sm">Day</label>
        <label class="col-span-1 text-sm">Start Time</label>
        <label class="col-span-1 text-sm">End Time</label>
      </div>
      <!-- JS-injected rows go here -->
    </form>
  </div>

  <!-- Calendar View -->
  <div id="calendar-view" class="hidden mt-6">
    <h2 class="text-xl font-bold mb-2">Available Creators</h2>
    <div id="calendar-grid" class="grid grid-cols-1 gap-2"></div>
  </div>

  <!-- Cancellation UI -->
  <div id="cancel-battle-module" class="hidden mt-6">
    <h2 class="text-xl font-bold mb-2">Cancel a Battle</h2>
    <input id="cancel-battle-id" placeholder="Enter Battle ID" class="w-full mb-2 p-2 bg-gray-800 rounded" />
    <input id="cancel-reason" placeholder="Reason for cancellation" class="w-full mb-2 p-2 bg-gray-800 rounded" />
    <button onclick="cancelBattle()" class="w-full bg-red-700 hover:bg-red-600 p-2 rounded">Submit Cancellation</button>
  </div>

  <!-- Admin Panel (UI now secured through backend call) -->
  <div id="admin-panel" class="hidden mt-6">
    <h2 class="text-xl font-bold mb-2">Admin Panel</h2>
    <div id="admin-user-list" class="space-y-2"></div>
  </div>

  <script>
const SUPABASE_URL = 'https://dptolytfqrdzhvdlntfb.client.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwdG9seXRmcXJkemh2ZGxudGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzUzMDksImV4cCI6MjA2NzU1MTMwOX0.gi8fekd2RZUomuAebzTU_Vs62pJXQBcSukr2evYcnok';  // Replace this with your actual anon key
    const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function toggleMenu() {
      document.getElementById("nav-menu").classList.toggle("hidden");
    }

    function showSection(id) {
      const sections = ["dashboard", "availability-module", "calendar-view", "cancel-battle-module", "admin-panel"];
      sections.forEach(sec => {
        const el = document.getElementById(sec);
        if (el) el.classList.add("hidden");
      });
      const target = document.getElementById(id);
      if (target) target.classList.remove("hidden");
      toggleMenu();
    }

    function showSignup() {
      document.getElementById('login-module').classList.add('hidden');
      document.getElementById('signup-module').classList.remove('hidden');
    }

    function showLogin() {
      document.getElementById('signup-module').classList.add('hidden');
      document.getElementById('login-module').classList.remove('hidden');
    }

    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      loadDashboard();
    }

    async function signup() {
      const name = document.getElementById('signup-name').value;
      const tiktok = document.getElementById('signup-tiktok').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const timezone = document.getElementById('signup-timezone').value;
      const diamond_range = document.getElementById('signup-diamonds').value;
      const agency = document.getElementById('signup-agency').value;

      const { data, error } = await client.auth.signUp({
        email, password,
        options: {
          data: { name, tiktok_username: tiktok, timezone, diamond_range, agency }
        }
      });
      if (error) return alert(error.message);
      loadDashboard();
    }

    async function resetPassword() {
      const email = prompt("Enter your email:");
      const { error } = await client.auth.resetPasswordForEmail(email);
      if (error) alert(error.message);
      else alert("Check your email for reset link.");
    }

    async function logout() {
      await client.auth.signOut();
      location.reload();
    }

    async function loadDashboard() {
      const { data: { user } } = await client.auth.getUser();
      if (!user) return;
      document.getElementById('login-module').classList.add('hidden');
      document.getElementById('signup-module').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('user-info').innerText = `Logged in as: ${user.email}`;
      document.getElementById('availability-module').classList.remove('hidden');
      loadAvailabilityForm();
      loadCalendar();
      if (user.email === "admin@goneviral.com") loadAdminPanel();
    }

    async function loadAvailabilityForm() {
      const form = document.getElementById("availability-form");
      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
      form.innerHTML = days.map(day => `
        <div class="grid grid-cols-3 gap-2 items-center">
          <input type="hidden" name="day" value="${day}">
          <input type="time" name="start-${day}" class="p-1 bg-gray-800 rounded"/>
          <input type="time" name="end-${day}" class="p-1 bg-gray-800 rounded"/>
        </div>`).join("") + `<button type="submit" class="mt-4 bg-blue-600 hover:bg-blue-500 p-2 rounded w-full">Save Availability</button>`;
    }

    document.getElementById("availability-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const { data: { user } } = await client.auth.getUser();
      if (!user) return alert("Not logged in");

      const timezone = user.user_metadata?.timezone || "UTC";
      const form = e.target;
      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

      for (let day of days) {
        const start = form[`start-${day}`].value;
        const end = form[`end-${day}`].value;
        if (start && end) {
          await client.from("availability").insert({
            user_id: user.id,
            day_of_week: day,
            start_time: start,
            end_time: end,
            timezone
          });
        }
      }

      alert("Availability saved!");
    });

    async function loadCalendar() {
      const { data: { user } } = await client.auth.getUser();
      if (!user) return;
      const currentRange = user.user_metadata?.diamond_range || "0-10K";

      const { data: records, error } = await supabase
        .from("availability")
        .select("*, user:auth.users(id, email, user_metadata)")
        .neq("user_id", user.id);

      const container = document.getElementById("calendar-grid");
      container.innerHTML = "";

      for (const record of records) {
        const other = record.user;
        const theirRange = other.user_metadata?.diamond_range || "0-0K";
        const color = getRangeColor(currentRange, theirRange);
        const card = document.createElement("div");
        card.className = `p-3 rounded bg-${color}-700 cursor-pointer hover:opacity-90`;
        card.innerHTML = `
          <p class="font-bold">${other.user_metadata?.tiktok_username || "Unknown"}</p>
          <p>${record.day_of_week}: ${record.start_time} - ${record.end_time}</p>
          <p>Range: ${theirRange}</p>
          <p>Agency: ${other.user_metadata?.agency || "None"}</p>
          <p>Timezone: ${record.timezone}</p>
          <button class="mt-2 bg-black bg-opacity-20 hover:bg-opacity-40 text-sm p-1 px-2 rounded"
            onclick="requestBattle('${record.user_id}', '${record.day_of_week}', '${record.start_time}', '${record.end_time}', '${record.timezone}')">Request Battle</button>`;
        container.appendChild(card);
      }

      document.getElementById("calendar-view").classList.remove("hidden");
    }

    function getRangeColor(myRange, theirRange) {
      const scale = ["0-5K", "0-10K", "0-20K", "20-50K", "50-100K", "100-200K", "200K+"];
      const mine = scale.indexOf(myRange);
      const theirs = scale.indexOf(theirRange);
      if (mine === theirs) return "green";
      if (mine > theirs) return "orange";
      return "red";
    }

    async function requestBattle(opponentId, day, start, end, timezone) {
      const confirmed = confirm(`Schedule battle with this creator on ${day} at ${start}?`);
      if (!confirmed) return;
      const { data: { user } } = await client.auth.getUser();
      const scheduledTime = new Date();
      scheduledTime.setHours(parseInt(start.split(":")[0]));
      scheduledTime.setMinutes(parseInt(start.split(":")[1]));
      const { error } = await client.from("battles").insert({
        creator_a_id: user.id,
        creator_b_id: opponentId,
        scheduled_at: scheduledTime.toISOString(),
        timezone,
        battle_confirmed_by_both: false
      });
      if (error) return alert("Error saving battle");
      alert("Battle requested!");
    }

    async function cancelBattle() {
      const battleId = document.getElementById("cancel-battle-id").value;
      const reason = document.getElementById("cancel-reason").value;
      const { data: { user } } = await client.auth.getUser();
      const { error } = await client.from("cancellations").insert({
        user_id: user.id,
        battle_id: battleId,
        reason
      });
      if (error) return alert("Failed to cancel.");
      const { data: cancels } = await client.from("cancellations").select("*").eq("user_id", user.id);
      if (cancels.length >= 3) {
        await client.auth.admin.updateUserById(user.id, {
          user_metadata: { ...user.user_metadata, restricted: true }
        });
        alert("You have been flagged due to 3+ cancellations.");
      } else {
        alert("Cancellation submitted.");
      }
    }

    async // Admin panel now powered by secure backend
function loadAdminPanel() {
  fetch('/.netlify/functions/get-users')
    .then(res => res.json())
    .then(users => {
      const container = document.getElementById("admin-user-list");
      container.innerHTML = "";
      users.forEach(u => {
        const meta = u.user_metadata || {};
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-2 rounded";
        div.innerHTML = `
          <p>Email: ${u.email}</p>
          <p>Username: ${meta?.tiktok_username || "N/A"}</p>
          <p>Restricted: ${meta?.restricted ? "✅" : "❌"}</p>
        `;
        container.appendChild(div);
      });
      document.getElementById("admin-panel").classList.remove("hidden");
    });
}
      const { data: { user } } = await client.auth.getUser();
      if (!user || user.email !== "admin@goneviral.com") return;
      const { data: users } = await client.auth.admin.listUsers();
      const container = document.getElementById("admin-user-list");
      container.innerHTML = "";
      for (const u of users) {
        const meta = u.user_metadata;
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-2 rounded";
        div.innerHTML = `
          <p>Email: ${u.email}</p>
          <p>Username: ${meta?.tiktok_username || "N/A"}</p>
          <p>Restricted: ${meta?.restricted ? "✅" : "❌"}</p>
          <button onclick="clearRestriction('${u.id}')" class="mt-1 bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded text-sm">Clear Restriction</button>`;
        container.appendChild(div);
      }
      document.getElementById("admin-panel").classList.remove("hidden");
    }

    async function clearRestriction(uid) {
      const { error } = await client.auth.admin.updateUserById(uid, {
        user_metadata: { restricted: false }
      });
      if (error) return alert("Failed to clear restriction");
      alert("Restriction cleared!");
      loadAdminPanel();
    }

    window.addEventListener('load', async () => {
      const { data: { session } } = await client.auth.getSession();
      if (session) loadDashboard();
    });
    // This section will be appended in the next step due to size
  </script>
</body>
</html>
