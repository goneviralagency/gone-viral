<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gone Viral: Availability</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: white; margin: 0; padding: 0; }
    h1 { text-align: center; margin: 1rem 0; }
    #calendar { max-width: 900px; margin: auto; background: white; color: black; border-radius: 10px; padding: 1rem; }
    #time-selector { text-align: center; margin-top: 1rem; }
    select { padding: 0.5rem; margin: 0.2rem; }
    button { padding: 0.5rem 1rem; background: #007aff; border: none; color: white; margin-top: 0.5rem; cursor: pointer; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Availability Calendar</h1>
  <div id="calendar"></div>
  <div id="time-selector" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
         background:#222; padding:1rem; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.5); max-width:90%; text-align:center;">
    <h2>Select Time Slots</h2>
    <p id="selected-date"></p>
    <select id="start-time"></select>
    <select id="end-time"></select>
    <br>
    <button onclick="saveAvailability()">Save Availability</button>
  </div>

  <script type="module">
    const SUPABASE_URL = 'https://dptolytfqrdzhvdlntfb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwdG9seXRmcXJkemh2ZGxudGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzUzMDksImV4cCI6MjA2NzU1MTMwOX0.gi8fekd2RZUomuAebzTU_Vs62pJXQBcSukr2evYcnok';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let selectedDate = null;

    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'dayGridMonth',
      selectable: true,
      dateClick: function(info) {
        selectedDate = info.dateStr;
        document.getElementById('selected-date').innerText = "Date: " + selectedDate;
        document.getElementById('time-selector').style.display = 'block';
        populateTimes();
      }
    });

    calendar.render();

    function populateTimes() {
      const startSel = document.getElementById('start-time');
      const endSel = document.getElementById('end-time');
      startSel.innerHTML = '';
      endSel.innerHTML = '';
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          let hour = h % 12 || 12;
          let ampm = h < 12 ? 'AM' : 'PM';
          const time = hour.toString().padStart(2, '0') + ':' + ('0' + m).slice(-2) + ' ' + ampm;
          const opt = new Option(time, time);
          startSel.add(opt.cloneNode(true));
          endSel.add(opt.cloneNode(true));
        }
      }
    }

    async function saveAvailability() {
      const startTime = document.getElementById('start-time').value;
      const endTime = document.getElementById('end-time').value;
      const user = (await client.auth.getUser()).data.user;
      if (!user) return alert("Not logged in.");

      function convertTo24Hour(timeStr) {
        const [time, modifier] = timeStr.split(" ");
        let [hours, minutes] = time.split(":");
        hours = parseInt(hours, 10);
        if (modifier === "PM" && hours !== 12) hours += 12;
        if (modifier === "AM" && hours === 12) hours = 0;
        return hours.toString().padStart(2, '0') + ':' + minutes;
      }

      const from = selectedDate + 'T' + convertTo24Hour(startTime) + ':00';
      const to = selectedDate + 'T' + convertTo24Hour(endTime) + ':00';
      const to = selectedDate + 'T' + endTime + ':00';

      const { error } = await client.from('availability').insert([{
        user_id: user.id,
        date: selectedDate,
        start_time: startTime,
        end_time: endTime
      }]);

      if (error) {
        alert("Error saving: " + error.message);
      } else {
        alert("Availability saved!");
        calendar.addEvent({ title: "Available", start: from, end: to, backgroundColor: 'green', borderColor: 'green' });
        document.getElementById('time-selector').style.display = 'none';
      }
    }
  </script>
</body>
</html>
