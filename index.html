
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gone Viral Portal</title>

<script type="module">
const SUPABASE_URL = 'https://dptolytfqrdzhvdlntfb.client.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwdG9seXRmcXJkemh2ZGxudGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzUzMDksImV4cCI6MjA2NzU1MTMwOX0.gi8fekd2RZUomuAebzTU_Vs62pJXQBcSukr2evYcnok';  // Replace this with your actual anon key
    const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function toggleMenu() {
      document.getElementById("nav-menu").classList.toggle("hidden");
    }

    function showSection(id) {
      const sections = ["dashboard", "availability-module", "calendar-view", "cancel-battle-module", "admin-panel"];
      sections.forEach(sec => {
        const el = document.getElementById(sec);
        if (el) el.classList.add("hidden");
      });
      const target = document.getElementById(id);
      if (target) target.classList.remove("hidden");
      toggleMenu();
    }

    function showSignup() {
      document.getElementById('login-module').classList.add('hidden');
      document.getElementById('signup-module').classList.remove('hidden');
    }

    function showLogin() {
      document.getElementById('signup-module').classList.add('hidden');
      document.getElementById('login-module').classList.remove('hidden');
    }

    async function login() {
  console.log('[DEBUG] Attempting login...');
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      loadDashboard();
    }

    async function signup() {
  console.log('[DEBUG] Attempting signup...');
      const name = document.getElementById('signup-name').value;
      const tiktok = document.getElementById('signup-tiktok').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const timezone = document.getElementById('signup-timezone').value;
      const diamond_range = document.getElementById('signup-diamonds').value;
      const agency = document.getElementById('signup-agency').value;

      const { data, error } = await client.auth.signUp({
        email, password,
        options: {
          data: { name, tiktok_username: tiktok, timezone, diamond_range, agency }
        }
      });
      if (error) return alert(error.message);
      loadDashboard();
    }

    async function resetPassword() {
      const email = prompt("Enter your email:");
      const { error } = await client.auth.resetPasswordForEmail(email);
      if (error) alert(error.message);
      else alert("Check your email for reset link.");
    }

    async function logout() {
      await client.auth.signOut();
      location.reload();
    }

    async function loadDashboard() {
  console.log('[DEBUG] Loading Dashboard...');
      const { data: { user } } = await client.auth.getUser();
      if (!user) return;
      document.getElementById('login-module').classList.add('hidden');
      document.getElementById('signup-module').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('user-info').innerText = `Logged in as: ${user.email}`;
      document.getElementById('availability-module').classList.remove('hidden');
      loadAvailabilityForm();
      loadCalendar();
      if (user.email === "admin@goneviral.com") loadAdminPanel();
    }

    async function loadAvailabilityForm() {
  console.log('[DEBUG] Loading Availability Form...');
  const form = document.getElementById("availability-form");
  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
  form.innerHTML = days.map(day => `
    <div class="grid grid-cols-3 gap-2 items-center">
      <input type="hidden" name="day" value="${day}">
      <input type="time" name="start-${day}" class="p-1 bg-gray-800 rounded"/>
      <input type="time" name="end-${day}" class="p-1 bg-gray-800 rounded"/>
    </div>`).join("") + `<button type="submit" class="mt-4 bg-blue-600 hover:bg-blue-500 p-2 rounded w-full">Save Availability</button>`;

  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    const { data: { user } } = await client.auth.getUser();
    if (!user) return alert("Not logged in");

    const timezone = user.user_metadata?.timezone || "UTC";
    for (let day of days) {
      const start = form.querySelector(`[name=start-${day}]`).value;
      const end = form.querySelector(`[name=end-${day}]`).value;
      if (start && end) {
        await client.from("availability").insert({
          user_id: user.id,
          day_of_week: day,
          start_time: start,
          end_time: end,
          timezone
        });
      }
    }

    alert("Availability saved!");
  });
}

    alert("Availability saved!");
    alert("Availability saved!");

      alert("Availability saved!");
      alert("Availability saved!");

    async function loadCalendar() {
  console.log('[DEBUG] Loading Calendar View...');
      const { data: { user } } = await client.auth.getUser();
      if (!user) return;
      const currentRange = user.user_metadata?.diamond_range || "0-10K";

      const { data: records, error } = await supabase
        .from("availability")
        .select("*, user:auth.users(id, email, user_metadata)")
        .neq("user_id", user.id);

      const container = document.getElementById("calendar-grid");
      container.innerHTML = "";

      for (const record of records) {
        const other = record.user;
        const theirRange = other.user_metadata?.diamond_range || "0-0K";
        const color = getRangeColor(currentRange, theirRange);
        const card = document.createElement("div");
        card.className = `p-3 rounded bg-${color}-700 cursor-pointer hover:opacity-90`;
        card.innerHTML = `
          <p class="font-bold">${other.user_metadata?.tiktok_username || "Unknown"}</p>
          <p>${record.day_of_week}: ${record.start_time} - ${record.end_time}</p>
          <p>Range: ${theirRange}</p>
          <p>Agency: ${other.user_metadata?.agency || "None"}</p>
          <p>Timezone: ${record.timezone}</p>
          <button class="mt-2 bg-black bg-opacity-20 hover:bg-opacity-40 text-sm p-1 px-2 rounded"
            onclick="requestBattle('${record.user_id}', '${record.day_of_week}', '${record.start_time}', '${record.end_time}', '${record.timezone}')">Request Battle</button>`;
        container.appendChild(card);
      }

      document.getElementById("calendar-view").classList.remove("hidden");
    }

    function getRangeColor(myRange, theirRange) {
      const scale = ["0-5K", "0-10K", "0-20K", "20-50K", "50-100K", "100-200K", "200K+"];
      const mine = scale.indexOf(myRange);
      const theirs = scale.indexOf(theirRange);
      if (mine === theirs) return "green";
      if (mine > theirs) return "orange";
      return "red";
    }

async function requestBattle(opponentId, day, start, end, timezone) {
  console.log('[DEBUG] Requesting Battle with:', opponentId, day, start, end, timezone);
  const confirmed = confirm(`Schedule battle with this creator on ${day} at ${start}?`);
  if (!confirmed) return;

  const { data: { user } } = await client.auth.getUser();
  const scheduledTime = new Date();
  scheduledTime.setHours(parseInt(start.split(":")[0]));
  scheduledTime.setMinutes(parseInt(start.split(":")[1]));

  const { error } = await client.from("battles").insert({
    creator_a_id: user.id,
    creator_b_id: opponentId,
    scheduled_at: scheduledTime.toISOString(),
    timezone,
    battle_confirmed_by_both: false
  });

  if (error) return alert("Error saving battle");
  alert("Battle requested!");
}
      for (const u of users) {
        const meta = u.user_metadata;
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-2 rounded";
        div.innerHTML = `
          <p>Email: ${u.email}</p>
          <p>Username: ${meta?.tiktok_username || "N/A"}</p>
          <p>Restricted: ${meta?.restricted ? "✅" : "❌"}</p>
          <button onclick="clearRestriction('${u.id}')" class="mt-1 bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded text-sm">Clear Restriction</button>`;
        container.appendChild(div);
      }
      document.getElementById("admin-panel").classList.remove("hidden");

    async function clearRestriction(uid) {
      const { error } = await client.auth.admin.updateUserById(uid, {
        user_metadata: { restricted: false }
      });
      if (error) return alert("Failed to clear restriction");
      alert("Restriction cleared!");
      loadAdminPanel();
    }

    window.addEventListener('load', async () => {
      const { data: { session } } = await client.auth.getSession();
      if (session) loadDashboard();
    });

// Expose functions to global window for button onclick access
window.login = login;
window.signup = signup;
window.showSignup = showSignup;
window.showLogin = showLogin;
window.resetPassword = resetPassword;
window.logout = logout;
window.cancelBattle = cancelBattle;
window.requestBattle = requestBattle;
window.clearRestriction = clearRestriction;
window.showSection = showSection;
window.toggleMenu = toggleMenu;
</script>
</body>
</html>

async function loadAdminPanel() {
  const { data: { user } } = await client.auth.getUser();
  if (!user || user.email !== "admin@goneviral.com") return;

  const { data: users } = await client.auth.admin.listUsers();
  if (!users) {
    alert("Failed to load users");
    return;
  }

  const container = document.getElementById("admin-user-list");
  container.innerHTML = "";

  for (const u of users) {
    const meta = u.user_metadata || {};
    const div = document.createElement("div");
    div.className = "bg-gray-800 p-2 rounded";
    div.innerHTML = `
      <p>Email: ${u.email}</p>
      <p>Username: ${meta.tiktok_username || "N/A"}</p>
      <p>Restricted: ${meta.restricted ? "✅" : "❌"}</p>
      <button onclick="clearRestriction('${u.id}')" class="mt-1 bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded text-sm">Clear Restriction</button>`;
    container.appendChild(div);
  }

  document.getElementById("admin-panel").classList.remove("hidden");
}