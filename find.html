<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Calendar</title>
  <style>
    body { font-family: 'Inter', sans-serif; margin: 0; background: #f9f9f9; color: #222; }
    h1 { text-align: center; margin: 90px 0 1rem 0; }
    .container { max-width: 800px; margin: auto; padding: 0 16px; }
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
    .header { background: #ddd; text-align: center; font-weight: bold; padding: 10px; }
    .day { background: white; border: 1px solid #ccc; padding: 10px; min-height: 80px; }
    .tag { display: block; padding: 4px 6px; margin: 4px 0; border-radius: 6px; font-size: 0.8rem; cursor: pointer; text-align: center; }
    .green { background: #a3eaa3; color: #1e4620; }
    .orange { background: #ffe5b4; color: #7a4a00; }
    .red { background: #f8b0b0; color: #a70000; }
    .popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 999; }
    .popup-box { background: white; padding: 20px; border-radius: 12px; text-align: center; max-width: 300px; }
    .popup-box button { margin-top: 10px; padding: 10px 20px; background: red; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
    #diamondRangeWrapper { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap; }
    select, button { font-size: 1rem; border-radius: 10px; padding: 8px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Battle Availability</h1>
  <div id="diamondRangeWrapper">
    <span><strong>Your Diamond Range:</strong></span>
    <select id="diamondRangeSelector"></select>
    <button id="saveDiamondRange">Save</button>
  </div>
  <select id="monthSelector"></select>
  <div id="calendar"></div>
  <div id="confirmationBadge" style="display:none;position:fixed;bottom:20px;right:20px;background:#28a745;color:#fff;padding:10px 20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.3);z-index:1000;">Request Sent ✔️</div>
</div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient('https://dptolytfqrdzhvdlntfb.supabase.co', 'YOUR_PUBLIC_ANON_KEY');

const levels = ["0-10K", "0-20K", "20-50K", "50-100K", "100-200K", "200K+"];
const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const calendar = document.getElementById("calendar");
const monthSelector = document.getElementById("monthSelector");
let currentUser = null;
let currentRange = "0-10K";

function getRangeLevel(range) {
  return levels.indexOf(range);
}

function getColorClass(userLevel, oppLevel) {
  if (userLevel === oppLevel) return "green";
  if (userLevel < oppLevel) return "orange";
  return "red";
}

function convertToLocalTime(timeStr, timezone) {
  try {
    const date = new Date(`1970-01-01T${timeStr}:00Z`);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZone: timezone });
  } catch {
    return timeStr;
  }
}

function generateMonthOptions() {
  const now = new Date();
  for (let i = -2; i <= 2; i++) {
    const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
    const opt = document.createElement("option");
    opt.value = date.toISOString();
    opt.text = date.toLocaleString("default", { month: "long", year: "numeric" });
    if (i === 0) opt.selected = true;
    monthSelector.appendChild(opt);
  }
}

async function fetchUserDiamondRange(userId) {
  const { data, error } = await supabase.from('users').select('diamond_range').eq('id', userId).single();
  return data?.diamond_range || "0-10K";
}

async function updateDiamondRange(userId, newRange) {
  await supabase.from('users').update({ diamond_range: newRange }).eq('id', userId);
}

async function requestBattle(e, userTZ) {
  const selected_time = e.start_time;
  const requesterUsername = currentUser?.user_metadata?.tiktok_username || "Unknown";
  const requesterAgency = currentUser?.user_metadata?.agency || "N/A";

  await supabase.from("availability")
    .update({ status: "filled" })
    .eq("user_id", e.user_id)
    .eq("date", e.date)
    .eq("start_time", e.start_time);

  await supabase.from("battles").insert([{
    requester_id: currentUser.id,
    recipient_id: e.user_id,
    date: e.date,
    time: selected_time,
    status: "Request Sent",
    requester_timezone: userTZ,
    recipient_timezone: e.user_timezone || "N/A",
    requester_range: currentRange,
    recipient_range: e.diamond_range || "Unknown",
    requester_username: requesterUsername,
    recipient_username: e.tiktok_username || "Unknown",
    requester_agency: requesterAgency,
    recipient_agency: e.agency || "N/A"
  }]);

  const badge = document.getElementById("confirmationBadge");
  if (badge) {
    badge.style.display = "block";
    setTimeout(() => { badge.style.display = "none"; }, 3000);
  }
  const popup = document.querySelector(".popup");
  if (popup) popup.remove();
}

// Calendar rendering with Supabase availability data
async function renderCalendar(dateStr) {
  const userTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const session = await supabase.auth.getSession();
  currentUser = session?.data?.session?.user;
  const userId = currentUser?.id;
  currentRange = await fetchUserDiamondRange(userId);

  const selected = new Date(dateStr);
  const year = selected.getFullYear();
  const month = selected.getMonth();
  const monthKey = `${year}-${String(month + 1).padStart(2, "0")}`;

  calendar.innerHTML = "";
  weekdays.forEach(day => {
    const header = document.createElement("div");
    header.className = "header";
    header.textContent = day;
    calendar.appendChild(header);
  });

  const firstDay = new Date(year, month, 1).getDay();
  const totalDays = new Date(year, month + 1, 0).getDate();

  const { data } = await supabase
    .from("availability_with_user")
    .select("*")
    .eq("month", monthKey)
    .neq("user_id", userId);

  const grouped = {};
  data?.forEach(entry => {
    if (!grouped[entry.date]) grouped[entry.date] = [];
    grouped[entry.date].push(entry);
  });

  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement("div"));
  }

  for (let day = 1; day <= totalDays; day++) {
    const dateKey = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
    const cell = document.createElement("div");
    cell.className = "day";
    cell.textContent = day;

    if (grouped[dateKey]) {
      grouped[dateKey].forEach(e => {
        const tag = document.createElement("span");
        const color = getColorClass(getRangeLevel(currentRange), getRangeLevel(e.diamond_range));
        tag.className = `tag ${color}`;
        tag.textContent = e.diamond_range;
        tag.onclick = () => {
          const modal = document.createElement("div");
          modal.className = "popup";
          modal.innerHTML = `
            <div class="popup-box">
              <h3>@${e.tiktok_username || "Unknown"}</h3>
              <p><strong>Diamond Range:</strong> ${e.diamond_range}</p>
              <p><strong>Timezone:</strong> ${e.user_timezone || "N/A"}</p>
              <p><strong>Start Time:</strong> ${convertToLocalTime(e.start_time, userTZ)}</p>
              <button id="confirmRequestBtn">REQUEST</button>
            </div>`;
          document.body.appendChild(modal);
          setTimeout(() => {
            const btn = document.getElementById("confirmRequestBtn");
            if (btn) btn.onclick = () => requestBattle(e, userTZ);
          }, 100);
        };
        cell.appendChild(tag);
      });
    }
    calendar.appendChild(cell);
  }
}

document.getElementById("saveDiamondRange").onclick = async () => {
  const newRange = document.getElementById("diamondRangeSelector").value;
  await updateDiamondRange(currentUser.id, newRange);
  currentRange = newRange;
  renderCalendar(monthSelector.value);
};

levels.forEach(lvl => {
  const opt = document.createElement("option");
  opt.value = lvl;
  opt.text = lvl;
  document.getElementById("diamondRangeSelector").appendChild(opt);
});

generateMonthOptions();
monthSelector.addEventListener("change", e => renderCalendar(e.target.value));
supabase.auth.getSession().then(({ data }) => {
  currentUser = data?.session?.user;
  if (currentUser) {
    renderCalendar(monthSelector.value);
  }
});
</script>
</body>
</html>
