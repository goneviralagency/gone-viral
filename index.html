<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gone Viral Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script type="module">
    const SUPABASE_URL = 'https://dptolytfqrdzhvdlntfb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // shortened for demo
    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadDashboard() {
      console.log('[DEBUG] Loading Dashboard...');
      const { data: { user } } = await client.auth.getUser();
      if (!user) return;

      const login = document.getElementById('login-module');
      const signup = document.getElementById('signup-module');
      const dash = document.getElementById('dashboard');
      const info = document.getElementById('user-info');
      const avail = document.getElementById('availability-module');

      if (login) login.classList.add("hidden");
      if (signup) signup.classList.add("hidden");
      if (dash) dash.classList.remove("hidden");
      if (info) info.innerText = `Logged in as: ${user.email}`;
      if (avail) avail.classList.remove("hidden");
    }

    async function cancelBattle() {
      const battleId = document.getElementById("cancel-battle-id")?.value;
      const reason = document.getElementById("cancel-reason")?.value;
      const { data: { user } } = await client.auth.getUser();

      const { error } = await client.from("cancellations").insert({
        user_id: user.id,
        battle_id: battleId,
        reason
      });

      if (error) return alert("Failed to cancel.");
      const { data: cancels } = await client.from("cancellations").select("*").eq("user_id", user.id);
      if (cancels.length >= 3) {
        await client.auth.admin.updateUserById(user.id, {
          user_metadata: { ...user.user_metadata, restricted: true }
        });
        alert("You have been flagged due to 3+ cancellations.");
      } else {
        alert("Cancellation submitted.");
      }
    }

    window.addEventListener('load', async () => {
      const { data: { session } } = await client.auth.getSession();
      if (session) loadDashboard();
    });

    // expose globals
    window.loadDashboard = loadDashboard;
async function login() {
  const email = document.getElementById("login-email")?.value;
  const password = document.getElementById("login-password")?.value;
  const { error } = await client.auth.signInWithPassword({ email, password });
  if (error) {
    alert("Login failed: " + error.message);
  } else {
    alert("Login successful!");
    loadDashboard();
  }
}
    window.cancelBattle = cancelBattle;
window.login = login;
  </script>
</head>
<body class="bg-gray-900 text-white font-sans p-4 min-h-screen">

<div id="login-module">
  <h2 class="text-xl font-bold mb-2">Login</h2>
  <input id="login-email" type="email" placeholder="Email" class="block w-full p-2 mb-2 bg-gray-800 rounded"/>
  <input id="login-password" type="password" placeholder="Password" class="block w-full p-2 mb-2 bg-gray-800 rounded"/>
  <button onclick="login()" class="bg-purple-600 hover:bg-purple-500 p-2 rounded w-full">Login</button>
</div>

  <div id="login-module" class="hidden">Login Placeholder</div>
  <div id="signup-module" class="hidden">Signup Placeholder</div>
  <div id="dashboard" class="hidden">
    <h1>Dashboard</h1>
    <div id="user-info"></div>
  </div>
  <div id="availability-module" class="hidden">Availability Placeholder</div>
  <div id="cancel-battle-module" class="hidden">
    <input id="cancel-battle-id" placeholder="Battle ID"/>
    <input id="cancel-reason" placeholder="Reason"/>
    <button onclick="cancelBattle()">Cancel Battle</button>
  </div>
</body>
</html>