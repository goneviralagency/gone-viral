
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gone Viral Battle App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f1f1f1;
      margin: 0;
    }
    h1 {
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .day {
      background: white;
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 60px;
    }
    .tag {
      display: inline-block;
      padding: 4px 8px;
      margin-top: 4px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .green { background: #a3eaa3; }
    .orange { background: #ffe5b4; }
    .red { background: #f8b0b0; }
    .header {
      font-weight: bold;
      text-align: center;
    }
    .popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .popup-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gone Viral Battle App</h1>
    <select id="monthSelector"></select>
    <div id="calendar" class="calendar"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      'https://dptolytfqrdzhvdlntfb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwdG9seXRmcXJkemh2ZGxudGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzUzMDksImV4cCI6MjA2NzU1MTMwOX0.gi8fekd2RZUomuAebzTU_Vs62pJXQBcSukr2evYcnok'
    );

    const levels = ["0-10K", "0-20K", "20-50K", "50-100K", "100-200K", "200K+"];
    const calendar = document.getElementById("calendar");
    const monthSelector = document.getElementById("monthSelector");
    let currentUser = null;
    let currentRange = "0-10K";

    function getRangeLevel(r) {
      return levels.indexOf(r);
    }

    function getColor(userLevel, oppLevel) {
      if (userLevel === oppLevel) return "green";
      if (userLevel < oppLevel) return "red";
      return "orange";
    }

    function convertTime(t, tz) {
      const date = new Date(`1970-01-01T${t}:00Z`);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZone: tz });
    }

    function generateMonthOptions() {
      const now = new Date();
      for (let i = -2; i <= 2; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        const opt = document.createElement("option");
        opt.value = date.toISOString();
        opt.text = date.toLocaleString("default", { month: "long", year: "numeric" });
        if (i === 0) opt.selected = true;
        monthSelector.appendChild(opt);
      }
    }

    async function login() {
      const { data: session } = await supabase.auth.getSession();
      if (session?.session?.user) {
        currentUser = session.session.user;
      } else {
        const email = prompt("Enter email:");
        const password = prompt("Enter password:");
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) return alert(error.message);
        currentUser = data.user;
      }

      const { data } = await supabase.from("users").select("*").eq("id", currentUser.id).single();
      currentRange = data?.diamond_range || "0-10K";
    }

    async function renderCalendar(dateStr) {
      const userLevel = getRangeLevel(currentRange);
      const userId = currentUser?.id;
      const userTZ = currentUser?.user_metadata?.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

      const selected = new Date(dateStr);
      const y = selected.getFullYear();
      const m = selected.getMonth();
      const monthKey = `${y}-${String(m + 1).padStart(2, "0")}`;
      calendar.innerHTML = "";

      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
        const div = document.createElement("div");
        div.className = "header";
        div.textContent = d;
        calendar.appendChild(div);
      });

      const firstDay = new Date(y, m, 1).getDay();
      const totalDays = new Date(y, m + 1, 0).getDate();
      const { data } = await supabase.from("availability_with_user").select("*").eq("month", monthKey).neq("user_id", userId);
      const grouped = {};
      data?.forEach(entry => {
        const key = entry.date;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(entry);
      });

      for (let i = 0; i < firstDay; i++) calendar.appendChild(document.createElement("div"));

      for (let d = 1; d <= totalDays; d++) {
        const dateKey = `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        const cell = document.createElement("div");
        cell.className = "day";
        cell.textContent = d;

        grouped[dateKey]?.forEach(e => {
          const safeRange = e.diamond_range ?? "MISSING";
          const tag = document.createElement("span");
          tag.className = `tag ${getColor(userLevel, getRangeLevel(safeRange))}`;
          tag.textContent = safeRange;

          tag.onclick = () => {
            if (!e.start_time || !e.end_time) {
              alert("Start or end time is missing.");
              return;
            }

            const [startHour, startMinute] = e.start_time.split(":").map(Number);
            const [endHour, endMinute] = e.end_time.split(":").map(Number);
            const start = new Date(Date.UTC(1970, 0, 1, startHour, startMinute));
            const end = new Date(Date.UTC(1970, 0, 1, endHour, endMinute));

            const modal = document.createElement("div");
            modal.className = "popup";

            let opts = "";
            for (let t = new Date(start); t < end; t.setMinutes(t.getMinutes() + 30)) {
              const iso = t.toISOString().substr(11,5);
              const local = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZone: userTZ });
              opts += `<option value="${iso}">${local}</option>`;
            }
            if (!opts) opts = `<option disabled>No slots available</option>`;

            
    modal.innerHTML = `
      <div class="popup-box" onclick="event.stopPropagation()">
        <h3>@${e.tiktok_username || "Unknown"}</h3>
        <p><strong>Date:</strong> ${e.date}</p>
        <p><strong>Scheduled Time:</strong> ${convertTime(e.start_time, userTZ)}</p>
        <button id="confirmBtn">Confirm Request</button>
      </div>`;
    document.body.appendChild(modal);
    modal.onclick = () => document.body.removeChild(modal);

    setTimeout(() => {
      
    document.getElementById("confirmBtn").onclick = function () {
      (async () => {
        const selected_time = e.start_time;
        const { error } = await supabase.from("battles").insert([{
          requester_id: currentUser.id,
          recipient_id: e.user_id,
          date: e.date,
          time: selected_time,
          status: "pending",
          requester_timezone: userTZ,
          recipient_timezone: e.user_timezone || "N/A",
          requester_range: currentRange,
          recipient_range: safeRange,
          requester_username: currentUser?.user_metadata?.tiktok_username || "Unknown",
          recipient_username: e.tiktok_username || "Unknown"
        }]);
        if (error) {
          alert("Failed: " + error.message);
        } else {
          alert("Battle request sent for " + convertTime(selected_time, userTZ));
          document.body.removeChild(modal);
        }
      })();
    };
    
    }, 100);
    
                const { error } = await supabase.from("battles").insert([{
                  requester_id: currentUser.id,
                  recipient_id: e.user_id,
                  date: e.date,
                  time: selected_time,
                  status: "pending",
                  requester_timezone: userTZ,
                  recipient_timezone: e.user_timezone || "N/A",
                  requester_range: currentRange,
                  recipient_range: safeRange,
                  requester_username: currentUser?.user_metadata?.tiktok_username || "Unknown",
                  recipient_username: e.tiktok_username || "Unknown"
                }]);
                if (error) {
                  alert("Failed: " + error.message);
                } else {
                  alert("Battle request sent!");
                  document.body.removeChild(modal);
                }
              };
            }, 100);
          };

          cell.appendChild(tag);
        });

        calendar.appendChild(cell);
      }
    }

    monthSelector.addEventListener("change", e => renderCalendar(e.target.value));
    generateMonthOptions();
    await login();
    renderCalendar(monthSelector.value);
  </script>
</body>
</html>
