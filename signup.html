
<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>Signup</title>
  <script type='module'>
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(
      'https://dptolytfqrdzhvdlntfb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
    )

    let debounceTimer
    const tiktokInput = document.getElementById('tiktok')
    const avatar = document.getElementById('avatar')
    const preview = document.getElementById('username-preview')
    const result = document.getElementById('result')

    async function fetchTikTokPreview(username) {
      try {
        const res = await fetch(`https://www.tiktok.com/@${username}`, {
          headers: { 'User-Agent': 'Mozilla/5.0' }
        })
        const html = await res.text()
        const avatarUrl = html.match(/"avatarLarger":"(.*?)"/)?.[1] || ''
        const usernameFound = html.match(/"uniqueId":"(.*?)"/)?.[1] || ''
        avatar.src = avatarUrl
        preview.textContent = '@' + usernameFound
      } catch (e) {
        avatar.src = ''
        preview.textContent = 'Not Found'
      }
    }

    tiktokInput.addEventListener('input', () => {
      clearTimeout(debounceTimer)
      const val = tiktokInput.value.replace('@', '').trim()
      if (val.length < 2) return
      debounceTimer = setTimeout(() => fetchTikTokPreview(val), 600)
    })

    window.signUp = async function (e) {
      e.preventDefault()
      const name = document.getElementById('name').value
      const email = document.getElementById('email').value
      const password = document.getElementById('password').value
      const confirm = document.getElementById('confirm').value
      const tiktok = tiktokInput.value.replace('@','').trim()
      const diamond = document.getElementById('diamond').value
      const timezone = document.getElementById('timezone').value
      const agency = document.getElementById('agency').value

      if (password !== confirm) return result.textContent = '❌ Passwords do not match.'

      let avatarUrl = '', username = tiktok
      try {
        const res = await fetch(`https://www.tiktok.com/@${tiktok}`, {
          headers: { 'User-Agent': 'Mozilla/5.0' }
        })
        const html = await res.text()
        avatarUrl = html.match(/"avatarLarger":"(.*?)"/)?.[1] || ''
        username = html.match(/"uniqueId":"(.*?)"/)?.[1] || tiktok
      } catch {}

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            name,
            tiktok_username: username,
            profile_url: avatarUrl,
            diamond_range: diamond,
            timezone,
            agency
          }
        }
      })

      result.textContent = error ? '❌ ' + error.message : '✅ Signup complete! You may now log in.'
      if (!error) setTimeout(() => window.location.href = '/login.html', 1500)
    }
  </script>
  <link href='https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css' rel='stylesheet' />
</head>
<body class='bg-black text-white p-6 font-sans'>
  <div class='max-w-md mx-auto space-y-6'>
    <h1 class='text-3xl text-pink-500 font-bold text-center'>Gone Viral Signup</h1>
    <form onsubmit='signUp(event)' class='space-y-4'>
      <input id='name' required placeholder='Full Name' class='w-full p-2 bg-gray-800 text-white rounded'>
      <input id='email' type='email' required placeholder='Email' class='w-full p-2 bg-gray-800 text-white rounded'>
      <input id='password' type='password' required placeholder='Password' class='w-full p-2 bg-gray-800 text-white rounded'>
      <input id='confirm' type='password' required placeholder='Confirm Password' class='w-full p-2 bg-gray-800 text-white rounded'>
      <input id='tiktok' required placeholder='TikTok Username (no @)' class='w-full p-2 bg-gray-800 text-white rounded'>

      <div class='flex items-center space-x-3 mt-1'>
        <img id='avatar' src='' class='w-12 h-12 rounded-full border border-pink-400' />
        <span id='username-preview' class='text-sm text-pink-300'></span>
      </div>

      <input id='agency' placeholder='Agency (optional)' class='w-full p-2 bg-gray-800 text-white rounded'>

      <select id='diamond' required class='w-full p-2 bg-gray-800 text-white rounded'>
        <option disabled selected>Diamond Range</option>
        <option value='0-5K'>0–5K</option>
        <option value='0-10K'>0–10K</option>
        <option value='0-20K'>0–20K</option>
        <option value='20-50K'>20–50K</option>
        <option value='50-100K'>50–100K</option>
        <option value='100-200K'>100–200K</option>
        <option value='200K+'>200K+</option>
      </select>

      <select id='timezone' required class='w-full p-2 bg-gray-800 text-white rounded'>
        <option disabled selected>Timezone</option>
        <option value='America/New_York'>US: Eastern</option>
        <option value='America/Chicago'>US: Central</option>
        <option value='America/Denver'>US: Mountain</option>
        <option value='America/Los_Angeles'>US: Pacific</option>
        <option value='America/Toronto'>CAN: Eastern</option>
        <option value='Europe/London'>UK</option>
        <option value='Asia/Manila'>PH</option>
        <option value='Australia/Sydney'>AUS</option>
        <option value='America/Mexico_City'>LATAM: Mexico City</option>
      </select>

      <button class='w-full bg-green-600 hover:bg-green-500 py-2 rounded'>Sign Up</button>
      <p id='result' class='text-red-400 text-sm text-center'></p>
    </form>
  </div>
</body>
</html>
